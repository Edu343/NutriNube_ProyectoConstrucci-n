name: Build and Sonar Analysis
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: 

jobs:
  sonarqube:
    name: SonarQube Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Compile Main Code
        run: |
          mkdir -p bin
          find src -name "*.java" > sources.txt
          javac -cp "lib/*" -d bin @sources.txt
          
      - name: Compile Unit Tests
        run: |
          find test -name "*.java" > test_sources.txt
          javac -cp "lib/*:bin" -d bin @test_sources.txt

      - name: Run Tests with JaCoCo
        run: |
          mkdir -p target
          
          # Buscamos el lanzador de JUnit
          JUNIT_LAUNCHER=$(find lib -name "junit-platform-console-standalone-*.jar" -print -quit)

          # Lógica de búsqueda del Agente JaCoCo (busca runtime, luego busca tu version)
          JACOCO_AGENT=$(find lib -name "*jacoco.agent-*-runtime.jar" -print -quit)
          if [ -z "$JACOCO_AGENT" ]; then
            # Si no encuentra el runtime, busca el JAR base de JaCoCo que subiste
            JACOCO_AGENT=$(find lib -name "org.jacoco.agent-*.jar" -print -quit)
          fi
          
          # Verificacion del CLI de JaCoCo (para el reporte XML)
          JACOCO_CLI=$(find lib -name "org.jacoco.cli-*-nodep.jar" -print -quit)

          if [ -z "$JACOCO_AGENT" ] || [ -z "$JUNIT_LAUNCHER" ] || [ -z "$JACOCO_CLI" ]; then
            echo "ERROR: Missing one or more critical JARs in 'lib/'."
            echo "JUNIT LAUNCHER: $JUNIT_LAUNCHER"
            echo "JACOCO AGENT: $JACOCO_AGENT"
            echo "JACOCO CLI: $JACOCO_CLI"
            exit 1
          fi

          # Ejecutar las pruebas con el agente JaCoCo
          java -jar "$JUNIT_LAUNCHER" \
            --class-path bin:lib/* \
            --scan-classpath \
            --include-classname-pattern ".*Test" \
            --disable-banner \
            -Djacoco.destfile=target/jacoco.exec \
            -javaagent:"$JACOCO_AGENT"=destfile=target/jacoco.exec,includes=Modelo.*:Controlador.*:Vista.*:Servicios.*
          
      - name: Generate JaCoCo XML Report
        run: |
          mkdir -p target/site/jacoco

          # El CLI ya fue buscado en el paso anterior
          if [ -z "$JACOCO_CLI" ]; then
             # Esto es un fallback, pero no debería ejecutarse si el paso anterior pasó
             JACOCO_CLI=$(find lib -name "org.jacoco.cli-*-nodep.jar" -print -quit)
          fi

          # Convertir el binario jacoco.exec a jacoco.xml
          java -jar "$JACOCO_CLI" report target/jacoco.exec \
            --classfiles bin \
            --sourcefiles src \
            --html target/site/jacoco \
            --xml target/site/jacoco/jacoco.xml
          
      - name: SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@v2.1.1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}